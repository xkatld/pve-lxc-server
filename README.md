# Proxmox LXC FastAPI 后端项目结构

## 项目目录结构

```
proxmox-lxc-api/
├── app/
│   ├── __init__.py
│   ├── main.py                     # FastAPI应用程序入口
│   ├── config.py                   # 配置文件
│   ├── database.py                 # 数据库连接配置
│   ├── models.py                   # 数据库模型
│   ├── schemas.py                  # Pydantic模式定义
│   ├── auth.py                     # API Key认证
│   ├── proxmox.py                  # Proxmox LXC服务
│   └── api.py                      # API路由
├── migrations/                     # 数据库迁移文件
│   └── init.sql
├── requirements.txt                # 项目依赖
├── .env.example                    # 环境变量示例
├── .env                           # 环境变量配置
├── docker-compose.yml              # Docker部署配置
└── README.md                       # 项目说明
```

## 核心文件功能说明

### config.py
管理应用程序的核心配置参数，包括数据库连接字符串、Proxmox服务器连接信息和API安全设置。配置信息通过环境变量进行管理，确保敏感信息不会硬编码在代码中。

### database.py
建立SQLAlchemy数据库连接会话管理。该文件负责创建数据库引擎、会话工厂和基础模型类，为整个应用程序提供统一的数据库访问接口。

### models.py
定义数据库表结构，包含API Key存储表和操作日志记录表。API Key表存储密钥信息、权限范围和有效期设置，日志表记录所有LXC容器操作的详细信息。

### schemas.py
使用Pydantic定义API请求和响应的数据结构验证模式。包含LXC容器的创建请求模式、状态响应模式和通用错误响应格式，确保API数据交换的规范性和类型安全。

### auth.py
实现基于自定义API Key的身份验证机制。该模块负责验证请求头中的API Key有效性，检查权限范围，并提供装饰器函数用于保护需要认证的API端点。

### proxmox.py
封装Proxmox VE的LXC容器管理功能。使用proxmoxer库与Proxmox API进行交互，提供容器创建、启动、停止、删除、配置修改和状态查询等核心功能。该模块处理与Proxmox服务器的连接管理和错误处理。

### api.py
定义所有RESTful API端点。包含LXC容器的完整生命周期管理接口，如容器列表查询、详细信息获取、创建新容器、启动和停止操作、配置更新和删除操作。每个端点都包含适当的请求验证和错误处理。

### main.py
FastAPI应用程序的主入口文件。初始化FastAPI应用实例，配置中间件，注册路由，设置异常处理器，并配置应用程序的启动和关闭事件处理。

## 数据库设计

### API Keys表
存储API密钥的核心信息，包括密钥哈希值、创建时间、最后使用时间、有效期和权限级别。支持API Key的启用和禁用状态管理，便于安全控制和访问管理。

### Operation Logs表
记录所有通过API执行的LXC操作详情。包含操作类型、目标容器ID、操作参数、执行结果、时间戳和使用的API Key信息。该设计支持操作审计和问题排查。

## 主要功能模块

### LXC容器管理
提供完整的LXC容器生命周期管理功能。支持基于不同模板创建容器，配置CPU、内存、存储和网络参数。实现容器的启动、停止、重启操作，以及运行状态的实时查询和监控。

### 配置管理
支持容器配置的动态修改，包括资源限制调整、网络配置更新和存储空间扩展。配置变更操作会记录详细日志，确保操作的可追溯性。

### 状态监控
提供容器运行状态的实时查询接口，包括CPU使用率、内存占用、网络流量和磁盘I/O统计信息。支持批量查询多个容器的状态信息。

## 安全特性

### API Key认证
每个API请求都需要在请求头中包含有效的API Key。系统验证API Key的有效性、权限范围和过期时间，确保只有授权用户才能执行相应操作。

### 操作日志记录
所有API调用和容器操作都会记录到数据库中，包含操作时间、执行用户、操作类型和结果状态。该机制支持安全审计和问题追踪。

### 权限控制
API Key支持不同的权限级别配置，可以限制某些Key只能执行查询操作，而其他Key具有完整的管理权限。这种设计确保了最小权限原则的实施。

## 部署配置

### Docker支持
项目包含完整的Docker配置文件，支持容器化部署。Docker Compose配置定义了应用程序、数据库和必要服务的完整部署栈，简化了部署和运维流程。

### 环境配置
通过环境变量管理不同环境的配置参数，支持开发、测试和生产环境的独立配置。配置文件模板确保了部署的一致性和安全性。

该简化结构专注于LXC容器管理的核心功能，去除了不必要的复杂性，同时保持了良好的代码组织和可维护性。整个项目结构清晰明了，便于快速开发和部署。
